version: '3.8'

services:
  # 1. Python Trade Executor (The Manager)
  trade-executor:
    # Ensure this points to your python folder (e.g. ./strategies-executor)
    build: ./trade-executor
    container_name: siphon-trade-executor
    ports:
      - "5005:5005"
    environment:
      # Connect to FHE Engine (service name 'fhe-engine' acts as hostname)
      - FHE_ENGINE_URL=http://fhe-engine:5001/evaluateStrategy
      - FHE_ENGINE_BRACKET_URL=http://fhe-engine:5001/evaluate_bracket_order
      - FHE_ENGINE_LIMIT_BUY_URL=http://fhe-engine:5001/evaluate_limit_buy
      - FHE_ENGINE_LIMIT_SELL_URL=http://fhe-engine:5001/evaluate_limit_sell
      
      # External Services
      - PYTH_HERMES_URL=https://hermes.pyth.network
      - ARKIV_RPC_URL=https://mendoza.hoodi.arkiv.network/rpc

      # Local Blockchain (Use host.docker.internal to reach Anvil on host)
      - SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/QKpJJ0vfOqVsi5962oHUd
      
      # Database
      - DATABASE_URI=sqlite:///strategies.db?timeout=30

      # Auth (must match across services)
      - API_TOKEN=${API_TOKEN}

      # Secrets (Pass these from your .env file)
      - SYPHON_VAULT_CONTRACT_ADDRESS=${SYPHON_VAULT_CONTRACT_ADDRESS}
      - EXECUTOR_PRIVATE_KEY=${EXECUTOR_PRIVATE_KEY}

    extra_hosts:
      - "host.docker.internal:host-gateway" # Critical for reaching local Anvil
    depends_on:
      - fhe-engine
    restart: unless-stopped

  # 2. Rust FHE Engine (The Calculator)
  fhe-engine:
    # Ensure this points to your Rust FHE folder (e.g. ./fhe)
    build: ./fhe
    container_name: syphon-fhe-engine
    ports:
      - "5001:5001"
    environment:
      - RUST_LOG=info
      - API_TOKEN=${API_TOKEN}
    restart: unless-stopped

  # 3. Rust Payload Generator (The Encryptor)
  payload-generator:
    # Ensure this points to your new generator folder (e.g. ./siphon-payload-generator)
    build: ./siphon-payload-generator-demo
    container_name: siphon-payload-generator
    ports:
      - "5009:5009"
    environment:
      - RUST_LOG=info
      - ORCHESTRATOR_URL=http://trade-executor:5005/createStrategy
      - API_TOKEN=${API_TOKEN}
    restart: unless-stopped